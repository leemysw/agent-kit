x-logging:
  logging: &default-logging
    driver: "local"
    options:
      max-size: "10m"
      max-file: "3"


services:
  agent-kit:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    image: ${IMAGE:-leemysw/agent-kit}:${TAG}
    restart: always
    environment:
      - TZ=Asia/Shanghai
      - SERVER_TYPE=gunicorn
    networks:
      - net
    volumes:
      - /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro
      - ../logs:/opt/app/logs
      - ../cache:/opt/app/cache
      - ${DEFAULT_CWD:-cwd}:/opt/app/playground
    env_file:
      - ../.env
    logging: *default-logging

  # 前端服务
  frontend:
    build:
      context: ../web
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_WS_URL=ws://localhost/agent/v1/chat/ws
        - NEXT_PUBLIC_API_URL=http://localhost/agent/v1
        - NEXT_PUBLIC_DEFAULT_MODEL=glm-4.6
        - NEXT_PUBLIC_DEFAULT_CWD=/opt/app/playground
    image: ${IMAGE:-leemysw/agent-kit-frontend}:${TAG}
    restart: always
    environment:
      - TZ=Asia/Shanghai
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
    networks:
      - net
    volumes:
      - /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro
    logging: *default-logging
    depends_on:
      - agent-kit


  # Nginx 反向代理
  nginx:
    image: nginx:alpine
    restart: always
    environment:
      - TZ=Asia/Shanghai
    networks:
      - net
    volumes:
      - /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - agent-kit
      - frontend
    logging: *default-logging

networks:
  net:
    external: true

volumes:
  cwd: